{% extends 'base.html' %}
{% load static %}
{% block title %}Determinante · KiwiSolve{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/components/cards.css' %}">
{% endblock %}

{% block content %}
<section class="section">
  <h1>{{ titulo }}</h1>
  <form method="post" class="form form-grid narrow" aria-describedby="det-descripcion">
    {% csrf_token %}
    <p id="det-descripcion" class="hint" style="margin-top:-.25rem;">Formato: [[...],[...]] sólo matrices cuadradas. Se aplicará eliminación para calcular det.</p>
    <div class="field">
      <label for="M">Matriz M (texto)</label>
      <textarea id="M" name="M" required>{{ M }}</textarea>
      <div style="margin-top:.35rem; display:flex; gap:.5rem; flex-wrap:wrap;">
        <button type="button" class="button outline js-open-math-editor" data-target="#M" aria-label="Abrir editor matemático para M">Editor (teclado)</button>
      </div>
    </div>
    <div class="field" style="display:flex; align-items:center; gap:.5rem;">
      <input id="registrar" type="checkbox" name="registrar" {% if registrar %}checked{% endif %}>
      <label for="registrar" style="font-weight:500;">Registrar pasos (Steps)</label>
    </div>
    <div>
      <button class="button gradient" type="submit">Calcular determinante</button>
      <a class="button outline" href="/">Volver</a>
    </div>
  </form>

  {% if error %}
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        if (window.Swal) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: "{{ error|escapejs }}",
            confirmButtonText: 'Cerrar'
          });
        }
      });
    </script>
  {% endif %}

  {% if resultado %}
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        if (window.Swal) {
          Swal.fire({
            icon: 'success',
            title: 'Correcto',
            text: 'Cálculo realizado correctamente.',
            timer: 1400,
            showConfirmButton: false
          });
        }
      });
    </script>
  {% endif %}

  {% if resultado %}
    <div class="result-card" style="margin-top:1rem;">
      <div class="result-header">
        <div class="title-actions">
          <h2>Resultado</h2>
          <button type="button" class="button outline" data-copy-matrix="#det-res" aria-label="Copiar resultado">Copiar</button>
        </div>
        <div class="chips">
          <span class="chip">M: {{ resultado.M|length }}×{{ resultado.M.0|length }}</span>
          <span class="chip">Operación: det(M)</span>
        </div>
      </div>
      <p style="margin:.25rem 0 0; font-size:1rem;">det(M) = <strong>{{ resultado.det_formateado }}</strong></p>
      <pre id="det-res" style="position:absolute; left:-9999px; top:-9999px;">det(M) = {{ resultado.det_formateado }}</pre>
    </div>
  {% endif %}

  {% if pasos and pasos|length > 0 %}
    <div class="card" style="margin-top:1rem;">
      <h2>Pasos</h2>
      <ol>
        {% for p in pasos %}
          <li><code>{{ p.etapa }}</code> — {{ p.msg }} {% if p.state %}<small>{{ p.state }}</small>{% endif %}</li>
        {% endfor %}
      </ol>
    </div>
  {% endif %}
</section>
{% endblock %}
